# Restic GUI 概要设计文档

**项目名称：** Restic GUI
**版本：** 1.1
**编写日期：** 2025-10-24
**文档状态：** 实现完成版
**实现状态：** 核心功能已全部实现，使用 Qt Designer .ui 文件方式

---

## 1. 引言

### 1.1 文档目的

本文档是Restic GUI项目的概要设计文档，描述系统的总体架构、模块划分、技术选型和核心设计思路。本文档为详细设计和编码实现提供指导。

### 1.2 适用范围

本文档适用于：
- 系统架构师
- 开发工程师
- 测试工程师
- 项目管理人员

### 1.3 参考文档

- 《Restic GUI 需求规格说明书》v1.1
- Qt 5.14官方文档
- Restic官方文档

---

## 2. 系统总体架构

### 2.1 架构模式

Restic GUI采用经典的**三层架构模式**，分离表现层、业务逻辑层和数据访问层，确保系统的可维护性和可扩展性。

```
┌─────────────────────────────────────────────────────────────┐
│                     表现层（Presentation Layer）              │
│  ┌──────────┬──────────┬──────────┬──────────┬──────────┐  │
│  │ 主窗口   │ 向导窗口 │ 对话框   │ 进度窗口 │ 设置界面 │  │
│  └──────────┴──────────┴──────────┴──────────┴──────────┘  │
└─────────────────────────────────────────────────────────────┘
                            ↕ (信号/槽机制)
┌─────────────────────────────────────────────────────────────┐
│                 业务逻辑层（Business Logic Layer）            │
│  ┌──────────┬──────────┬──────────┬──────────┬──────────┐  │
│  │仓库管理器│备份管理器│恢复管理器│快照管理器│任务调度器│  │
│  └──────────┴──────────┴──────────┴──────────┴──────────┘  │
│  ┌───────────────────────────────────────────────────────┐  │
│  │           Restic命令包装器（ResticWrapper）           │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                            ↕
┌─────────────────────────────────────────────────────────────┐
│                 数据访问层（Data Access Layer）               │
│  ┌──────────────────┬──────────────────┬─────────────────┐  │
│  │  配置管理器      │  数据库管理器    │  日志管理器     │  │
│  │  (QSettings)     │  (SQLite)        │  (QFile)        │  │
│  └──────────────────┴──────────────────┴─────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                            ↕
┌─────────────────────────────────────────────────────────────┐
│                      外部依赖                                 │
│  ┌──────────────────┬──────────────────┬─────────────────┐  │
│  │  Restic命令行工具│  文件系统        │  网络服务       │  │
│  └──────────────────┴──────────────────┴─────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 架构分层说明

#### 2.2.1 表现层（Presentation Layer）

**职责：**
- 展示用户界面
- 接收用户输入
- 显示业务逻辑层返回的结果

**主要组件：**
- **MainWindow：** 主窗口，包含侧边栏导航和内容区域（.ui 文件）
- **Pages：** 6个主要页面（HomePage、RepositoryPage、BackupPage、SnapshotPage、RestorePage、StatsPage，均使用.ui文件）
- **Wizards：** 向导界面（CreateRepoWizard，采用纯代码方式以支持动态页面）
- **Dialogs：** 对话框（ProgressDialog、SettingsDialog、PruneOptionsDialog等，主要使用.ui文件）
- **Custom Widgets：** 自定义控件（FileTreeWidget、SnapshotListWidget，采用纯代码方式）

**技术：** Qt Widgets + Qt Designer .ui 文件

**UI实现方式：**
- 标准界面组件使用 Qt Designer .ui 文件（共10个.ui文件）
- 向导和自定义控件使用纯代码方式以支持复杂的动态逻辑
- 所有.ui文件通过uic自动生成ui_XXX.h头文件

#### 2.2.2 业务逻辑层（Business Logic Layer）

**职责：**
- 实现核心业务逻辑
- 调用restic命令行工具
- 数据验证和转换
- 业务规则执行

**主要组件：**
- **ResticWrapper：** 封装所有restic命令调用
- **RepositoryManager：** 仓库管理业务逻辑
- **BackupManager：** 备份业务逻辑
- **RestoreManager：** 恢复业务逻辑
- **SnapshotManager：** 快照管理业务逻辑
- **SchedulerManager：** 定时任务调度

**技术：** Qt Core（QObject、QThread、QProcess等）

**注：** 所有管理器类采用单例模式，通过instance()方法获取实例

#### 2.2.3 数据访问层（Data Access Layer）

**职责：**
- 数据持久化
- 配置读写
- 日志记录

**主要组件：**
- **ConfigManager：** 应用配置管理（基于QSettings）
- **DatabaseManager：** 数据库操作（SQLite）
- **LogManager：** 日志记录和管理
- **CacheManager：** 缓存管理（快照列表等）

**技术：** QSettings、Qt SQL、QFile

### 2.3 关键技术决策

| 技术选型 | 选用方案 | 理由 |
|---------|---------|------|
| UI框架 | Qt Widgets | 成熟稳定，跨平台，符合Qt 5.14要求 |
| UI设计 | Qt Designer .ui 文件 | 可视化设计，UI与逻辑分离，易于维护 |
| 构建工具 | qmake | Qt原生构建系统，简单可靠 |
| 进程通信 | QProcess | Qt原生支持，便于管理restic进程 |
| 数据库 | SQLite | 轻量级，无需独立服务，Qt内置支持 |
| 配置存储 | QSettings | 跨平台配置管理，自动适配系统 |
| 异步处理 | QThread + 信号/槽 + QtConcurrent | Qt标准异步模式，避免阻塞UI |
| JSON解析 | QJsonDocument | Qt内置，无需第三方库 |
| 日志系统 | 自定义Logger + QFile | 简单有效，可自定义输出和级别 |
| 定时任务 | QTimer | Qt标准定时器，精度满足需求 |

---

## 3. 模块划分

### 3.1 模块概览

```
ResticGUI
├── Core（核心模块）
│   ├── ResticWrapper（restic命令封装）
│   ├── RepositoryManager（仓库管理）
│   ├── BackupManager（备份管理）
│   ├── RestoreManager（恢复管理）
│   ├── SnapshotManager（快照管理）
│   └── SchedulerManager（任务调度）
├── UI（界面模块）
│   ├── MainWindow（主窗口，.ui文件）
│   ├── Pages（6个页面，.ui文件）
│   ├── Wizards（向导，纯代码）
│   ├── Dialogs（对话框，大部分使用.ui文件）
│   └── Widgets（自定义控件，纯代码）
├── Data（数据模块）
│   ├── Models（数据模型）
│   ├── DatabaseManager（数据库访问）
│   ├── ConfigManager（配置管理）
│   ├── PasswordManager（密码管理）
│   └── CacheManager（缓存管理）
├── Utils（工具模块）
│   ├── Logger（日志工具）
│   ├── CryptoUtil（加密工具）
│   ├── FileSystemUtil（文件系统工具）
│   └── NetworkUtil（网络工具）
└── Resources（资源）
    ├── icons/（图标）
    ├── translations/（翻译文件）
    ├── sql/（数据库脚本）
    └── styles/（样式表）
```

### 3.2 核心模块详细设计

#### 3.2.1 ResticWrapper模块

**功能：** 封装所有restic命令行调用，提供统一的接口

**核心类：** `ResticWrapper`

**主要方法：**
```cpp
class ResticWrapper : public QObject {
    Q_OBJECT

public:
    // 仓库操作
    bool init(const Repository& repo, const QString& password);
    bool check(const Repository& repo, bool readData = false);

    // 备份操作
    QString backup(const BackupTask& task);

    // 快照操作
    QList<Snapshot> snapshots(const Repository& repo);
    QStringList ls(const QString& snapshotId);

    // 恢复操作
    bool restore(const QString& snapshotId, const QString& target,
                 const QStringList& include);

    // 快照管理
    bool forget(const QStringList& snapshotIds);
    bool prune(const Repository& repo);

    // 统计信息
    RepoStats stats(const Repository& repo);

signals:
    void commandStarted(const QString& command);
    void commandOutput(const QString& output);
    void commandError(const QString& error);
    void commandFinished(int exitCode);
    void progressUpdate(int percentage, const QString& status);

private:
    QProcess* executeCommand(const QStringList& args);
    QJsonDocument parseJsonOutput(const QString& output);
    void setupEnvironment(const Repository& repo);
};
```

**设计要点：**
- 所有方法返回值或通过信号异步返回结果
- 自动处理环境变量设置（密码、仓库路径等）
- 统一的错误处理机制
- 进度解析（从restic的输出中提取进度信息）

#### 3.2.2 RepositoryManager模块

**功能：** 管理仓库的创建、连接、配置和验证

**核心类：** `RepositoryManager`

**主要方法：**
```cpp
class RepositoryManager : public QObject {
    Q_OBJECT

public:
    // CRUD操作
    bool addRepository(const Repository& repo);
    bool updateRepository(const Repository& repo);
    bool removeRepository(int repoId);
    QList<Repository> getAllRepositories();
    Repository getRepository(int repoId);

    // 仓库操作
    bool initRepository(const Repository& repo, const QString& password);
    bool testConnection(const Repository& repo, const QString& password);
    bool checkRepository(const Repository& repo, bool full = false);

    // 密码管理
    bool cachePassword(int repoId, const QString& password);
    QString getCachedPassword(int repoId);
    void clearPasswordCache();

signals:
    void repositoryAdded(int repoId);
    void repositoryUpdated(int repoId);
    void repositoryRemoved(int repoId);
    void checkProgress(int percentage);
    void checkFinished(bool success, const QString& message);

private:
    DatabaseManager* m_db;
    QMap<int, QString> m_passwordCache;  // 内存中的密码缓存
    ResticWrapper* m_restic;
};
```

**设计要点：**
- 仓库信息持久化到数据库
- 密码可选择缓存到内存或加密存储
- 支持多种后端类型的参数配置
- 连接验证包含密码验证和基本通信测试

#### 3.2.3 BackupManager模块

**功能：** 管理备份任务的创建、执行和监控

**核心类：** `BackupManager`

**主要方法：**
```cpp
class BackupManager : public QObject {
    Q_OBJECT

public:
    // 任务管理
    int createTask(const BackupTask& task);
    bool updateTask(const BackupTask& task);
    bool deleteTask(int taskId);
    QList<BackupTask> getAllTasks();
    BackupTask getTask(int taskId);

    // 执行备份
    bool executeTask(int taskId);
    bool executeTaskAsync(int taskId);
    void cancelTask(int taskId);

    // 历史记录
    QList<BackupHistory> getHistory(int taskId = -1);

signals:
    void taskCreated(int taskId);
    void taskUpdated(int taskId);
    void taskDeleted(int taskId);

    void backupStarted(int taskId);
    void backupProgress(int taskId, int percentage, const QString& status);
    void backupFinished(int taskId, bool success, const BackupResult& result);

private:
    DatabaseManager* m_db;
    ResticWrapper* m_restic;
    QMap<int, QProcess*> m_runningTasks;  // 正在执行的任务

    void saveHistory(int taskId, const BackupResult& result);
};
```

**设计要点：**
- 备份任务配置存储到数据库
- 支持同步和异步执行
- 实时进度反馈
- 执行历史记录
- 支持任务取消

#### 3.2.4 RestoreManager模块

**功能：** 管理数据恢复操作

**核心类：** `RestoreManager`

**主要方法：**
```cpp
class RestoreManager : public QObject {
    Q_OBJECT

public:
    // 浏览快照
    FileTreeModel* browseSnapshot(const QString& snapshotId);

    // 搜索文件
    QList<FileInfo> findFiles(const QString& pattern,
                              const QString& snapshotId = QString());

    // 恢复操作
    bool restore(const QString& snapshotId,
                 const QString& targetPath,
                 const QStringList& includePaths,
                 const RestoreOptions& options);

    void cancelRestore();

signals:
    void restoreStarted();
    void restoreProgress(int percentage, const QString& currentFile);
    void restoreFinished(bool success, const RestoreResult& result);

private:
    ResticWrapper* m_restic;
    QProcess* m_currentProcess;

    FileTreeModel* parseFileList(const QJsonArray& files);
};
```

**设计要点：**
- 文件树按需加载，节省内存
- 支持增量加载大型快照
- 恢复选项灵活配置
- 进度实时反馈

#### 3.2.5 SnapshotManager模块

**功能：** 管理快照的查看、删除和清理

**核心类：** `SnapshotManager`

**主要方法：**
```cpp
class SnapshotManager : public QObject {
    Q_OBJECT

public:
    // 查询快照
    QList<Snapshot> getSnapshots(int repoId, const SnapshotFilter& filter);
    Snapshot getSnapshotDetail(const QString& snapshotId);

    // 删除快照
    bool forgetSnapshots(const QStringList& snapshotIds);
    bool forgetByPolicy(const ForgetPolicy& policy);

    // 清理仓库
    bool prune(int repoId);

    // 标签管理
    bool addTags(const QStringList& snapshotIds, const QStringList& tags);
    bool removeTags(const QStringList& snapshotIds, const QStringList& tags);

    // 统计信息
    RepoStats getRepoStats(int repoId);

signals:
    void snapshotsLoaded(const QList<Snapshot>& snapshots);
    void snapshotDeleted(const QString& snapshotId);
    void pruneProgress(int percentage);
    void pruneFinished(const PruneResult& result);

private:
    ResticWrapper* m_restic;
    CacheManager* m_cache;

    void updateCache(int repoId, const QList<Snapshot>& snapshots);
};
```

**设计要点：**
- 快照列表支持缓存
- 支持按策略批量删除
- Prune操作进度监控
- 标签批量操作

#### 3.2.6 SchedulerManager模块

**功能：** 管理定时备份任务

**核心类：** `SchedulerManager`

**主要方法：**
```cpp
class SchedulerManager : public QObject {
    Q_OBJECT

public:
    void start();
    void stop();

    // 任务调度
    void scheduleTask(int taskId, const Schedule& schedule);
    void unscheduleTask(int taskId);
    void updateSchedule(int taskId, const Schedule& schedule);

    // 手动触发
    void triggerTask(int taskId);

    // 查询状态
    QList<ScheduledTask> getScheduledTasks();
    NextExecution getNextExecution(int taskId);

signals:
    void taskTriggered(int taskId);
    void taskCompleted(int taskId, bool success);
    void schedulerError(const QString& error);

private slots:
    void onTimerTick();
    void onTaskFinished(int taskId, bool success);

private:
    BackupManager* m_backupManager;
    QTimer* m_timer;
    QMap<int, Schedule> m_schedules;

    bool shouldExecute(const Schedule& schedule);
    void executeScheduledTask(int taskId);
};
```

**设计要点：**
- 使用QTimer实现定时检查（每分钟一次）
- 支持多种调度策略（小时、日、周、月、自定义cron）
- 条件检查（电源、网络、系统空闲）
- 任务队列管理，避免并发冲突

---

## 4. 数据模型设计

### 4.1 核心数据结构

#### 4.1.1 Repository（仓库）

```cpp
struct Repository {
    int id;                         // 数据库ID
    QString name;                   // 仓库名称（GUI内部使用）
    QString type;                   // 类型：local, sftp, s3, rest等
    QString path;                   // 路径或连接字符串
    QVariantMap config;             // 配置参数（根据类型不同）
    QString passwordHash;           // 加密后的密码（可选）
    QDateTime createdAt;            // 创建时间
    QDateTime lastBackup;           // 最后备份时间
    bool isDefault;                 // 是否为默认仓库
};
```

#### 4.1.2 BackupTask（备份任务）

```cpp
struct BackupTask {
    int id;                         // 任务ID
    QString name;                   // 任务名称
    int repositoryId;               // 目标仓库ID
    QStringList sourcePaths;        // 备份源路径列表
    QStringList excludePatterns;    // 排除模式
    QStringList tags;               // 标签
    QString hostname;               // 主机名
    QVariantMap options;            // 其他选项
    Schedule schedule;              // 调度配置
    bool enabled;                   // 是否启用
    QDateTime createdAt;
    QDateTime updatedAt;
};
```

#### 4.1.3 Schedule（调度配置）

```cpp
struct Schedule {
    enum Type {
        None,           // 不调度
        Hourly,         // 每小时
        Daily,          // 每天
        Weekly,         // 每周
        Monthly,        // 每月
        Custom          // 自定义（cron表达式）
    };

    Type type;
    QTime time;                     // 执行时间（Daily、Weekly、Monthly）
    int dayOfWeek;                  // 星期几（Weekly，0=周日）
    int dayOfMonth;                 // 每月第几天（Monthly）
    QString cronExpression;         // 自定义cron表达式
    bool requireAC;                 // 需要连接电源
    bool requireNetwork;            // 需要网络连接
    bool requireIdle;               // 需要系统空闲
};
```

#### 4.1.4 Snapshot（快照）

```cpp
struct Snapshot {
    QString id;                     // 快照ID（短ID）
    QString fullId;                 // 完整ID
    QDateTime time;                 // 创建时间
    QString hostname;               // 主机名
    QString username;               // 用户名
    QStringList paths;              // 备份路径
    QStringList tags;               // 标签
    QString parent;                 // 父快照ID
    qint64 size;                    // 大小（字节）
    int fileCount;                  // 文件数量
    int dirCount;                   // 目录数量
};
```

#### 4.1.5 FileInfo（文件信息）

```cpp
struct FileInfo {
    enum Type {
        File,
        Directory,
        Symlink,
        Other
    };

    QString path;                   // 完整路径
    QString name;                   // 文件名
    Type type;                      // 类型
    qint64 size;                    // 大小
    QDateTime mtime;                // 修改时间
    QString permissions;            // 权限
    int uid;                        // 用户ID
    int gid;                        // 组ID
};
```

#### 4.1.6 BackupResult（备份结果）

```cpp
struct BackupResult {
    bool success;                   // 是否成功
    QString snapshotId;             // 快照ID
    int filesNew;                   // 新增文件数
    int filesChanged;               // 修改文件数
    int filesUnmodified;            // 未修改文件数
    qint64 dataAdded;               // 新增数据量（字节）
    qint64 dataProcessed;           // 处理数据量（字节）
    int duration;                   // 持续时间（秒）
    QString errorMessage;           // 错误消息
};
```

### 4.2 数据库表设计

数据库设计详见《数据库设计文档》，此处列出主要表：

- **repositories：** 仓库信息
- **backup_tasks：** 备份任务配置
- **backup_history：** 备份执行历史
- **schedules：** 调度配置
- **settings：** 应用设置
- **password_store：** 加密密码存储（可选）

---

## 5. 界面设计

### 5.1 主窗口结构

```
┌─────────────────────────────────────────────────────────────┐
│  Restic GUI                                    [_] [□] [X]   │
├──────────┬──────────────────────────────────────────────────┤
│          │                                                   │
│  [图标]  │                                                   │
│  首页    │                                                   │
│          │                                                   │
│  [图标]  │                                                   │
│  仓库管理│                                                   │
│          │                                                   │
│  [图标]  │            主内容区域                             │
│  备份任务│                                                   │
│          │                                                   │
│  [图标]  │                                                   │
│  快照管理│                                                   │
│          │                                                   │
│  [图标]  │                                                   │
│  恢复数据│                                                   │
│          │                                                   │
│  [图标]  │                                                   │
│  统计信息│                                                   │
│          │                                                   │
│  [图标]  │                                                   │
│  设置    │                                                   │
│          │                                                   │
├──────────┴──────────────────────────────────────────────────┤
│  当前仓库: 本地备份仓库  |  最后备份: 2025-10-20 10:30      │
└─────────────────────────────────────────────────────────────┘
```

**实现要点：**
- 使用`QMainWindow`作为主窗口
- 左侧使用`QListWidget`或自定义导航栏
- 右侧使用`QStackedWidget`切换不同页面
- 状态栏使用`QStatusBar`

### 5.2 向导界面结构

所有向导统一采用以下结构：

```
┌─────────────────────────────────────────────────────────────┐
│  创建备份任务                                   [_] [□] [X]  │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ● 基本信息  →  ○ 选择源  →  ○ 排除规则  →  ○ 定时配置    │
│                                                               │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  步骤1: 基本信息                                             │
│                                                               │
│  请输入备份任务的名称和描述                                  │
│                                                               │
│  任务名称: [________________]                                │
│                                                               │
│  描述(可选):                                                 │
│  ┌──────────────────────────────────────────────────────┐  │
│  │                                                        │  │
│  │                                                        │  │
│  └──────────────────────────────────────────────────────┘  │
│                                                               │
│  目标仓库: [本地备份仓库          ▼]                        │
│                                                               │
├─────────────────────────────────────────────────────────────┤
│                                     [上一步] [下一步] [取消]│
└─────────────────────────────────────────────────────────────┘
```

**实现要点：**
- 使用`QWizard`基类
- 每个步骤一个`QWizardPage`
- 顶部步骤指示器自动管理
- 支持字段验证（`QWizardPage::validatePage()`）

### 5.3 进度窗口

```
┌─────────────────────────────────────────────────────────────┐
│  正在备份...                                    [_] [□] [X] │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  任务: 工作文档备份                                          │
│  目标: 本地备份仓库                                          │
│                                                               │
│  正在处理: /home/user/work/document.pdf                      │
│                                                               │
│  [████████████████████──────────────] 68%                     │
│                                                               │
│  已处理: 3250 / 4780 文件                                    │
│  数据量: 1.2 GB / 1.8 GB                                     │
│  速度: 12.5 MB/s                                             │
│  剩余时间: 约 2 分钟                                         │
│                                                               │
│  ▼ 详细信息                                                   │
│                                                               │
│                                                               │
├─────────────────────────────────────────────────────────────┤
│                                                    [取消]    │
└─────────────────────────────────────────────────────────────┘
```

**实现要点：**
- 使用`QProgressDialog`或自定义对话框
- 进度条使用`QProgressBar`
- 详细信息可折叠（`QTextEdit`）
- 支持后台运行（最小化到托盘）

---

## 6. 进程管理与通信

### 6.1 进程调用方式

使用`QProcess`调用restic命令行工具：

```cpp
QProcess* ResticWrapper::executeCommand(const QStringList& args) {
    QProcess* process = new QProcess(this);

    // 设置程序路径
    QString program = ConfigManager::instance()->resticPath();

    // 设置环境变量
    QProcessEnvironment env = QProcessEnvironment::systemEnvironment();
    env.insert("RESTIC_REPOSITORY", m_currentRepo.path);
    env.insert("RESTIC_PASSWORD", m_currentPassword);
    process->setProcessEnvironment(env);

    // 连接信号
    connect(process, &QProcess::readyReadStandardOutput,
            this, &ResticWrapper::onStandardOutput);
    connect(process, &QProcess::readyReadStandardError,
            this, &ResticWrapper::onStandardError);
    connect(process, QOverload<int, QProcess::ExitStatus>::of(&QProcess::finished),
            this, &ResticWrapper::onProcessFinished);

    // 启动进程
    process->start(program, args);

    return process;
}
```

### 6.2 输出解析

restic支持`--json`选项输出JSON格式，便于解析：

```cpp
void ResticWrapper::onStandardOutput() {
    QProcess* process = qobject_cast<QProcess*>(sender());
    QString output = QString::fromUtf8(process->readAllStandardOutput());

    // 逐行解析
    QStringList lines = output.split('\n', Qt::SkipEmptyParts);
    for (const QString& line : lines) {
        if (line.startsWith('{')) {
            // JSON格式输出
            QJsonDocument doc = QJsonDocument::fromJson(line.toUtf8());
            if (!doc.isNull()) {
                parseJsonOutput(doc.object());
            }
        } else {
            // 普通文本输出
            emit commandOutput(line);
        }
    }
}

void ResticWrapper::parseJsonOutput(const QJsonObject& obj) {
    // 进度信息
    if (obj.contains("percent_done")) {
        double percent = obj["percent_done"].toDouble();
        QString status = obj["current_file"].toString();
        emit progressUpdate(static_cast<int>(percent * 100), status);
    }

    // 快照信息
    if (obj.contains("snapshot_id")) {
        // ...
    }
}
```

### 6.3 异步执行

长时间运行的命令（如备份、恢复）使用异步执行，避免阻塞UI：

```cpp
void BackupManager::executeTaskAsync(int taskId) {
    // 在新线程中执行
    QtConcurrent::run([this, taskId]() {
        BackupTask task = getTask(taskId);
        emit backupStarted(taskId);

        BackupResult result = doBackup(task);

        emit backupFinished(taskId, result.success, result);
        saveHistory(taskId, result);
    });
}
```

---

## 7. 安全性设计

### 7.1 密码管理

**存储方式：**
1. **不存储（默认）：** 每次操作要求用户输入
2. **会话缓存：** 仅在内存中保存，应用关闭后清除
3. **加密存储：** 使用系统密钥库或AES加密后存储

**实现：**
```cpp
class PasswordManager {
public:
    // 缓存密码（仅内存）
    void cachePassword(int repoId, const QString& password);
    QString getCachedPassword(int repoId);

    // 加密存储（可选）
    bool storePassword(int repoId, const QString& password);
    QString retrievePassword(int repoId);

    // 使用系统密钥库（Windows: DPAPI, Linux: Secret Service）
    bool useSystemKeychain();

private:
    QMap<int, QString> m_cache;
    CryptoUtil* m_crypto;
};
```

### 7.2 加密存储

使用Qt的`QCA`（Qt Cryptographic Architecture）或简单的AES实现：

```cpp
class CryptoUtil {
public:
    // 加密
    QString encrypt(const QString& plaintext, const QString& key);

    // 解密
    QString decrypt(const QString& ciphertext, const QString& key);

private:
    // 使用AES-256-CBC
    QByteArray deriveKey(const QString& password);
};
```

### 7.3 日志脱敏

确保日志中不包含敏感信息：

```cpp
QString sanitizeCommand(const QString& command) {
    QString safe = command;

    // 隐藏密码相关参数
    QRegularExpression passwordRe("(--password-file|RESTIC_PASSWORD)=\\S+");
    safe.replace(passwordRe, "\\1=***");

    // 隐藏凭证
    QRegularExpression credRe("(AWS_SECRET_ACCESS_KEY|B2_ACCOUNT_KEY)=\\S+");
    safe.replace(credRe, "\\1=***");

    return safe;
}
```

---

## 8. 错误处理策略

### 8.1 错误分类

| 错误类型 | 处理策略 |
|---------|---------|
| **网络错误** | 自动重试（可配置次数），失败后提示用户 |
| **认证错误** | 提示用户重新输入密码，限制尝试次数 |
| **文件系统错误** | 显示详细错误，建议解决方案 |
| **配置错误** | 检测并提示修复，提供默认值 |
| **restic进程崩溃** | 记录日志，清理资源，通知用户 |

### 8.2 错误处理示例

```cpp
void BackupManager::handleBackupError(const QString& error) {
    // 分析错误类型
    if (error.contains("password")) {
        // 密码错误
        emit errorOccurred(ErrorType::Authentication,
                          "密码错误，请重新输入");
        clearPasswordCache();
    } else if (error.contains("network") || error.contains("timeout")) {
        // 网络错误
        if (m_retryCount < MAX_RETRY) {
            m_retryCount++;
            QTimer::singleShot(5000, this, &BackupManager::retryBackup);
        } else {
            emit errorOccurred(ErrorType::Network,
                              "网络连接失败，已达到最大重试次数");
        }
    } else {
        // 其他错误
        emit errorOccurred(ErrorType::Unknown, error);
    }
}
```

---

## 9. 性能优化策略

### 9.1 数据缓存

- **快照列表缓存：** 定期更新，减少频繁调用
- **文件树缓存：** 按需加载，节省内存
- **仓库统计缓存：** 长效缓存，手动刷新

```cpp
class CacheManager {
public:
    // 设置缓存有效期
    void setCacheExpiry(const QString& key, int seconds);

    // 获取缓存（自动检查过期）
    QVariant getCache(const QString& key);

    // 设置缓存
    void setCache(const QString& key, const QVariant& value);

    // 清除缓存
    void clearCache(const QString& key = QString());

private:
    struct CacheEntry {
        QVariant value;
        QDateTime expiry;
    };

    QMap<QString, CacheEntry> m_cache;
};
```

### 9.2 异步加载

- 大型列表分页加载
- 文件树懒加载
- 后台预加载常用数据

```cpp
// 分页加载快照列表
QList<Snapshot> SnapshotManager::getSnapshots(int page, int pageSize) {
    int offset = page * pageSize;
    return m_cache->getSnapshotPage(offset, pageSize);
}
```

### 9.3 进程池

限制同时运行的restic进程数量，避免资源耗尽：

```cpp
class ProcessPool {
public:
    void setMaxProcesses(int max);

    // 提交任务，如果超过限制则排队
    void submitTask(std::function<void()> task);

private:
    int m_maxProcesses = 3;
    int m_runningCount = 0;
    QQueue<std::function<void()>> m_queue;

    void executeNext();
};
```

---

## 10. 国际化设计

虽然当前仅支持中文，但预留国际化接口：

```cpp
// 使用Qt翻译机制
QString tr(const char* text) {
    return QObject::tr(text);
}

// 所有UI文本使用tr()包裹
QPushButton* button = new QPushButton(tr("开始备份"));

// 翻译文件: translations/restic_gui_zh_CN.ts
```

---

## 11. 部署架构

### 11.1 目录结构

```
ResticGUI/
├── bin/
│   ├── restic-gui(.exe)        # 主程序
│   └── restic(.exe)            # restic工具（可选，内嵌分发）
├── lib/
│   └── Qt5*.dll / *.so         # Qt运行库（Windows/Linux）
├── translations/
│   └── restic_gui_zh_CN.qm     # 翻译文件
├── config/
│   └── restic-gui.conf         # 配置文件
└── logs/
    └── restic-gui.log          # 日志文件
```

### 11.2 打包方案

- **Windows：** 使用NSIS或Inno Setup打包安装程序，包含Qt运行库
- **Linux：** 打包为AppImage或deb/rpm包
- **macOS：** 打包为.dmg或.app

---

## 12. 技术风险与对策

| 风险 | 可能性 | 影响 | 对策 |
|------|-------|------|------|
| restic版本兼容性问题 | 中 | 高 | 检测restic版本，适配命令参数 |
| 大型备份内存溢出 | 低 | 中 | 使用流式处理，限制内存缓存 |
| 跨平台路径问题 | 中 | 中 | 使用QDir、QFileInfo统一处理 |
| 网络不稳定导致失败 | 高 | 中 | 自动重试机制，断点续传（restic支持） |
| Qt 5.14生命周期结束 | 低 | 低 | 后续版本可升级到Qt 6 |

---

## 13. 开发计划

详见《需求规格说明书》第9节，概要阶段主要关注：

1. **Week 1：** 搭建项目框架，实现ResticWrapper基础封装
2. **Week 2：** 完成RepositoryManager和基本UI框架
3. **Week 3：** 完成BackupManager和备份向导
4. **Week 4：** 完成RestoreManager和恢复功能
5. **Week 5：** 完成SnapshotManager和定时任务
6. **Week 6：** 统计功能和界面优化
7. **Week 7：** 集成测试和bug修复

---

## 14. 附录

### 14.1 设计模式应用

- **单例模式：** ConfigManager、LogManager
- **工厂模式：** 创建不同类型的仓库配置
- **观察者模式：** Qt信号/槽机制
- **策略模式：** 不同的调度策略
- **命令模式：** 封装restic命令

### 14.2 代码规范

- 遵循Qt编码规范
- 类名使用PascalCase
- 成员变量使用m_前缀
- 信号/槽命名清晰（on前缀）
- 注释使用Doxygen格式

### 14.3 测试策略

- **单元测试：** 核心业务逻辑类
- **集成测试：** restic命令调用
- **UI测试：** 主要用户流程
- **性能测试：** 大数据量场景

---

**文档结束**
