# Restic GUI 数据库设计文档

**项目名称：** Restic GUI
**版本：** 1.1
**编写日期：** 2025-10-24
**文档状态：** 实现完成版
**数据库类型：** SQLite 3
**实现状态：** 所有表结构已通过DatabaseManager实现

---

## 1. 概述

### 1.1 数据库用途

Restic GUI使用SQLite作为本地数据库，存储以下数据：

- 仓库配置信息
- 备份任务配置
- 备份执行历史
- 应用程序设置
- 密码存储（可选）

### 1.2 数据库文件位置

- **Windows：** `%APPDATA%\ResticGUI\restic-gui.db`
- **Linux：** `~/.config/ResticGUI/restic-gui.db`
- **macOS：** `~/Library/Application Support/ResticGUI/restic-gui.db`

### 1.3 数据库版本管理

使用版本号管理数据库schema变更，支持自动迁移。

```sql
CREATE TABLE IF NOT EXISTS schema_version (
    version INTEGER PRIMARY KEY,
    applied_at TEXT NOT NULL
);
```

当前版本：**v1**

---

## 2. 数据表设计

### 2.1 repositories（仓库表）

**用途：** 存储restic仓库的配置信息

```sql
CREATE TABLE repositories (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL UNIQUE,              -- 仓库名称（GUI中显示）
    type TEXT NOT NULL,                     -- 仓库类型：local, sftp, s3, rest, azure, gs, b2
    path TEXT NOT NULL,                     -- 仓库路径或连接字符串
    config TEXT,                            -- JSON格式的配置参数（根据类型不同）
    password_hash TEXT,                     -- 加密后的密码（可选）
    created_at TEXT NOT NULL,               -- 创建时间（ISO 8601格式）
    last_backup TEXT,                       -- 最后一次备份时间（ISO 8601格式）
    is_default INTEGER DEFAULT 0,           -- 是否为默认仓库（0=否，1=是）

    CHECK (type IN ('local', 'sftp', 's3', 'rest', 'azure', 'gs', 'b2', 'rclone')),
    CHECK (is_default IN (0, 1))
);

-- 索引
CREATE INDEX idx_repositories_type ON repositories(type);
CREATE INDEX idx_repositories_is_default ON repositories(is_default);
```

**字段说明：**

| 字段 | 类型 | 说明 | 示例 |
|------|------|------|------|
| id | INTEGER | 主键，自增 | 1 |
| name | TEXT | 仓库名称 | "本地备份仓库" |
| type | TEXT | 仓库类型 | "local" |
| path | TEXT | 路径或URL | "/srv/restic-repo" |
| config | TEXT | JSON配置 | `{"compression": "auto"}` |
| password_hash | TEXT | 加密密码 | NULL（不存储）或加密字符串 |
| created_at | TEXT | 创建时间 | "2025-10-20T10:30:00" |
| last_backup | TEXT | 最后备份时间 | "2025-10-20T14:00:00" |
| is_default | INTEGER | 是否默认 | 1 |

**config字段JSON格式示例：**

```json
// local类型
{}

// sftp类型
{
    "host": "192.168.1.100",
    "port": 22,
    "user": "backup",
    "ssh_key": "/path/to/key"
}

// s3类型
{
    "endpoint": "s3.amazonaws.com",
    "bucket": "my-backup",
    "region": "us-east-1",
    "access_key_id": "AKIAIOSFODNN7EXAMPLE",
    "secret_access_key": "***"  // 加密存储
}
```

### 2.2 backup_tasks（备份任务表）

**用途：** 存储备份任务的配置

```sql
CREATE TABLE backup_tasks (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,                     -- 任务名称
    description TEXT,                       -- 任务描述
    repository_id INTEGER NOT NULL,         -- 目标仓库ID
    source_paths TEXT NOT NULL,             -- JSON数组：备份源路径列表
    exclude_patterns TEXT,                  -- JSON数组：排除模式
    tags TEXT,                              -- JSON数组：标签
    hostname TEXT,                          -- 主机名（覆盖默认）
    options TEXT,                           -- JSON对象：其他选项
    schedule_type INTEGER DEFAULT 0,        -- 调度类型：0=不调度，1=小时，2=天，3=周，4=月，5=自定义
    schedule_config TEXT,                   -- JSON对象：调度配置
    enabled INTEGER DEFAULT 1,              -- 是否启用（0=禁用，1=启用）
    created_at TEXT NOT NULL,               -- 创建时间
    updated_at TEXT NOT NULL,               -- 更新时间

    FOREIGN KEY (repository_id) REFERENCES repositories(id) ON DELETE CASCADE,
    CHECK (schedule_type BETWEEN 0 AND 5),
    CHECK (enabled IN (0, 1))
);

-- 索引
CREATE INDEX idx_backup_tasks_repository ON backup_tasks(repository_id);
CREATE INDEX idx_backup_tasks_enabled ON backup_tasks(enabled);
CREATE INDEX idx_backup_tasks_schedule_type ON backup_tasks(schedule_type);
```

**字段说明：**

| 字段 | 类型 | 说明 | 示例 |
|------|------|------|------|
| id | INTEGER | 主键 | 1 |
| name | TEXT | 任务名称 | "工作文档备份" |
| description | TEXT | 描述 | "备份/home/user/work目录" |
| repository_id | INTEGER | 仓库ID | 1 |
| source_paths | TEXT | 源路径JSON数组 | `["/home/user/work", "/home/user/documents"]` |
| exclude_patterns | TEXT | 排除模式JSON数组 | `["*.tmp", "node_modules/", ".git/"]` |
| tags | TEXT | 标签JSON数组 | `["work", "daily"]` |
| hostname | TEXT | 主机名 | "my-laptop" |
| options | TEXT | 其他选项JSON | `{"verbose": true}` |
| schedule_type | INTEGER | 调度类型 | 2（每天） |
| schedule_config | TEXT | 调度配置JSON | `{"time": "02:00", "requireAC": true}` |
| enabled | INTEGER | 是否启用 | 1 |
| created_at | TEXT | 创建时间 | "2025-10-20T10:00:00" |
| updated_at | TEXT | 更新时间 | "2025-10-20T10:30:00" |

**schedule_config字段JSON格式：**

```json
// 每天
{
    "time": "02:00",
    "requireAC": true,
    "requireNetwork": false,
    "requireIdle": true
}

// 每周
{
    "dayOfWeek": 0,  // 0=周日
    "time": "02:00",
    "requireAC": true
}

// 每月
{
    "dayOfMonth": 1,
    "time": "02:00"
}

// 自定义cron
{
    "cronExpression": "0 2 * * 0"
}
```

### 2.3 backup_history（备份历史表）

**用途：** 记录每次备份的执行结果

```sql
CREATE TABLE backup_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    task_id INTEGER NOT NULL,               -- 备份任务ID
    snapshot_id TEXT,                       -- 快照ID（成功时）
    start_time TEXT NOT NULL,               -- 开始时间
    end_time TEXT NOT NULL,                 -- 结束时间
    success INTEGER NOT NULL,               -- 是否成功（0=失败，1=成功）
    files_new INTEGER DEFAULT 0,            -- 新增文件数
    files_changed INTEGER DEFAULT 0,        -- 修改文件数
    files_unmodified INTEGER DEFAULT 0,     -- 未修改文件数
    data_added INTEGER DEFAULT 0,           -- 新增数据量（字节）
    data_processed INTEGER DEFAULT 0,       -- 处理数据量（字节）
    duration INTEGER DEFAULT 0,             -- 持续时间（秒）
    error_message TEXT,                     -- 错误消息（失败时）

    FOREIGN KEY (task_id) REFERENCES backup_tasks(id) ON DELETE CASCADE,
    CHECK (success IN (0, 1))
);

-- 索引
CREATE INDEX idx_backup_history_task ON backup_history(task_id);
CREATE INDEX idx_backup_history_start_time ON backup_history(start_time);
CREATE INDEX idx_backup_history_success ON backup_history(success);
```

**字段说明：**

| 字段 | 类型 | 说明 | 示例 |
|------|------|------|------|
| id | INTEGER | 主键 | 1 |
| task_id | INTEGER | 任务ID | 1 |
| snapshot_id | TEXT | 快照ID | "a3f5c8d2" |
| start_time | TEXT | 开始时间 | "2025-10-20T14:00:00" |
| end_time | TEXT | 结束时间 | "2025-10-20T14:15:30" |
| success | INTEGER | 是否成功 | 1 |
| files_new | INTEGER | 新增文件 | 125 |
| files_changed | INTEGER | 修改文件 | 8 |
| files_unmodified | INTEGER | 未修改文件 | 3567 |
| data_added | INTEGER | 新增数据（字节） | 1024000000（约1GB） |
| data_processed | INTEGER | 处理数据 | 5120000000（约5GB） |
| duration | INTEGER | 持续时间（秒） | 930 |
| error_message | TEXT | 错误消息 | NULL |

### 2.4 settings（设置表）

**用途：** 存储应用程序全局设置

```sql
CREATE TABLE settings (
    key TEXT PRIMARY KEY,                   -- 设置键
    value TEXT,                             -- 设置值（JSON或纯文本）
    updated_at TEXT NOT NULL                -- 更新时间
);
```

**常用设置项：**

| key | value | 说明 |
|-----|-------|------|
| `app.version` | "1.0.0" | 应用版本 |
| `app.theme` | "light" | 主题（light/dark） |
| `app.language` | "zh_CN" | 语言 |
| `backup.threads` | "4" | 备份线程数 |
| `backup.retry_count` | "3" | 重试次数 |
| `network.timeout` | "30" | 网络超时（秒） |
| `log.level` | "2" | 日志级别（0-4） |
| `password.cache_duration` | "60" | 密码缓存时长（分钟） |
| `restic.path` | "/usr/bin/restic" | restic可执行文件路径 |

### 2.5 password_store（密码存储表，可选）

**用途：** 加密存储仓库密码

```sql
CREATE TABLE password_store (
    repository_id INTEGER PRIMARY KEY,      -- 仓库ID
    encrypted_password TEXT NOT NULL,       -- 加密后的密码
    iv TEXT NOT NULL,                       -- 初始化向量（IV）
    salt TEXT NOT NULL,                     -- 盐值
    created_at TEXT NOT NULL,               -- 创建时间
    updated_at TEXT NOT NULL,               -- 更新时间

    FOREIGN KEY (repository_id) REFERENCES repositories(id) ON DELETE CASCADE
);
```

**说明：**
- 密码使用AES-256-CBC加密
- 密钥从用户主密码或系统密钥库派生
- IV和salt用于增强安全性

### 2.6 snapshots_cache（快照缓存表，可选）

**用途：** 缓存快照列表，减少restic命令调用

```sql
CREATE TABLE snapshots_cache (
    id TEXT PRIMARY KEY,                    -- 快照ID
    repository_id INTEGER NOT NULL,         -- 仓库ID
    snapshot_time TEXT NOT NULL,            -- 快照时间
    hostname TEXT,                          -- 主机名
    username TEXT,                          -- 用户名
    paths TEXT NOT NULL,                    -- JSON数组：备份路径
    tags TEXT,                              -- JSON数组：标签
    parent_id TEXT,                         -- 父快照ID
    size INTEGER,                           -- 大小（字节）
    file_count INTEGER,                     -- 文件数量
    dir_count INTEGER,                      -- 目录数量
    cached_at TEXT NOT NULL,                -- 缓存时间

    FOREIGN KEY (repository_id) REFERENCES repositories(id) ON DELETE CASCADE
);

-- 索引
CREATE INDEX idx_snapshots_cache_repository ON snapshots_cache(repository_id);
CREATE INDEX idx_snapshots_cache_time ON snapshots_cache(snapshot_time);
```

---

## 3. 数据关系图

```
┌──────────────────┐
│   repositories   │
│                  │
│  id (PK)         │
│  name            │◄────┐
│  type            │     │
│  ...             │     │
└──────────────────┘     │
                         │
         ┌───────────────┴──────────────┐
         │                              │
         │                              │
┌────────▼──────────┐       ┌───────────▼───────────┐
│   backup_tasks    │       │   password_store      │
│                   │       │                        │
│  id (PK)          │       │  repository_id (PK,FK)│
│  repository_id(FK)│       │  encrypted_password   │
│  name             │       └───────────────────────┘
│  source_paths     │
│  ...              │
└───────┬───────────┘
        │
        │
┌───────▼────────────┐       ┌──────────────────────┐
│  backup_history    │       │  snapshots_cache     │
│                    │       │                      │
│  id (PK)           │       │  id (PK)             │
│  task_id (FK)      │       │  repository_id (FK)  │
│  snapshot_id       │       │  snapshot_time       │
│  start_time        │       │  ...                 │
│  ...               │       └──────────────────────┘
└────────────────────┘

                             ┌──────────────────────┐
                             │      settings        │
                             │                      │
                             │  key (PK)            │
                             │  value               │
                             └──────────────────────┘
```

---

## 4. 数据完整性约束

### 4.1 主键约束

所有表都有主键，确保每条记录唯一。

### 4.2 外键约束

- `backup_tasks.repository_id` → `repositories.id`（CASCADE DELETE）
- `backup_history.task_id` → `backup_tasks.id`（CASCADE DELETE）
- `password_store.repository_id` → `repositories.id`（CASCADE DELETE）
- `snapshots_cache.repository_id` → `repositories.id`（CASCADE DELETE）

**级联删除说明：**
- 删除仓库时，自动删除相关的备份任务、历史记录、密码和缓存
- 删除备份任务时，自动删除相关的历史记录

### 4.3 检查约束

- `repositories.type`：限定为已知类型
- `repositories.is_default`：0或1
- `backup_tasks.schedule_type`：0-5
- `backup_tasks.enabled`：0或1
- `backup_history.success`：0或1

### 4.4 唯一性约束

- `repositories.name`：仓库名称唯一

---

## 5. 初始化脚本

```sql
-- ========================================
-- Restic GUI 数据库初始化脚本
-- 版本：v1
-- ========================================

PRAGMA foreign_keys = ON;

-- 版本管理表
CREATE TABLE IF NOT EXISTS schema_version (
    version INTEGER PRIMARY KEY,
    applied_at TEXT NOT NULL
);

-- 仓库表
CREATE TABLE IF NOT EXISTS repositories (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL UNIQUE,
    type TEXT NOT NULL,
    path TEXT NOT NULL,
    config TEXT,
    password_hash TEXT,
    created_at TEXT NOT NULL,
    last_backup TEXT,
    is_default INTEGER DEFAULT 0,

    CHECK (type IN ('local', 'sftp', 's3', 'rest', 'azure', 'gs', 'b2', 'rclone')),
    CHECK (is_default IN (0, 1))
);

CREATE INDEX IF NOT EXISTS idx_repositories_type ON repositories(type);
CREATE INDEX IF NOT EXISTS idx_repositories_is_default ON repositories(is_default);

-- 备份任务表
CREATE TABLE IF NOT EXISTS backup_tasks (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    description TEXT,
    repository_id INTEGER NOT NULL,
    source_paths TEXT NOT NULL,
    exclude_patterns TEXT,
    tags TEXT,
    hostname TEXT,
    options TEXT,
    schedule_type INTEGER DEFAULT 0,
    schedule_config TEXT,
    enabled INTEGER DEFAULT 1,
    created_at TEXT NOT NULL,
    updated_at TEXT NOT NULL,

    FOREIGN KEY (repository_id) REFERENCES repositories(id) ON DELETE CASCADE,
    CHECK (schedule_type BETWEEN 0 AND 5),
    CHECK (enabled IN (0, 1))
);

CREATE INDEX IF NOT EXISTS idx_backup_tasks_repository ON backup_tasks(repository_id);
CREATE INDEX IF NOT EXISTS idx_backup_tasks_enabled ON backup_tasks(enabled);
CREATE INDEX IF NOT EXISTS idx_backup_tasks_schedule_type ON backup_tasks(schedule_type);

-- 备份历史表
CREATE TABLE IF NOT EXISTS backup_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    task_id INTEGER NOT NULL,
    snapshot_id TEXT,
    start_time TEXT NOT NULL,
    end_time TEXT NOT NULL,
    success INTEGER NOT NULL,
    files_new INTEGER DEFAULT 0,
    files_changed INTEGER DEFAULT 0,
    files_unmodified INTEGER DEFAULT 0,
    data_added INTEGER DEFAULT 0,
    data_processed INTEGER DEFAULT 0,
    duration INTEGER DEFAULT 0,
    error_message TEXT,

    FOREIGN KEY (task_id) REFERENCES backup_tasks(id) ON DELETE CASCADE,
    CHECK (success IN (0, 1))
);

CREATE INDEX IF NOT EXISTS idx_backup_history_task ON backup_history(task_id);
CREATE INDEX IF NOT EXISTS idx_backup_history_start_time ON backup_history(start_time);
CREATE INDEX IF NOT EXISTS idx_backup_history_success ON backup_history(success);

-- 设置表
CREATE TABLE IF NOT EXISTS settings (
    key TEXT PRIMARY KEY,
    value TEXT,
    updated_at TEXT NOT NULL
);

-- 密码存储表（可选）
CREATE TABLE IF NOT EXISTS password_store (
    repository_id INTEGER PRIMARY KEY,
    encrypted_password TEXT NOT NULL,
    iv TEXT NOT NULL,
    salt TEXT NOT NULL,
    created_at TEXT NOT NULL,
    updated_at TEXT NOT NULL,

    FOREIGN KEY (repository_id) REFERENCES repositories(id) ON DELETE CASCADE
);

-- 快照缓存表（可选）
CREATE TABLE IF NOT EXISTS snapshots_cache (
    id TEXT PRIMARY KEY,
    repository_id INTEGER NOT NULL,
    snapshot_time TEXT NOT NULL,
    hostname TEXT,
    username TEXT,
    paths TEXT NOT NULL,
    tags TEXT,
    parent_id TEXT,
    size INTEGER,
    file_count INTEGER,
    dir_count INTEGER,
    cached_at TEXT NOT NULL,

    FOREIGN KEY (repository_id) REFERENCES repositories(id) ON DELETE CASCADE
);

CREATE INDEX IF NOT EXISTS idx_snapshots_cache_repository ON snapshots_cache(repository_id);
CREATE INDEX IF NOT EXISTS idx_snapshots_cache_time ON snapshots_cache(snapshot_time);

-- 插入默认设置
INSERT OR IGNORE INTO settings (key, value, updated_at) VALUES
    ('app.version', '1.0.0', datetime('now')),
    ('app.theme', 'light', datetime('now')),
    ('app.language', 'zh_CN', datetime('now')),
    ('backup.threads', '4', datetime('now')),
    ('backup.retry_count', '3', datetime('now')),
    ('network.timeout', '30', datetime('now')),
    ('log.level', '1', datetime('now')),
    ('password.cache_duration', '60', datetime('now'));

-- 记录schema版本
INSERT OR REPLACE INTO schema_version (version, applied_at) VALUES
    (1, datetime('now'));
```

---

## 6. 数据迁移策略

### 6.1 版本升级

当需要修改数据库schema时，使用以下策略：

```cpp
class DatabaseMigration {
public:
    static bool migrate(QSqlDatabase& db, int fromVersion, int toVersion) {
        for (int v = fromVersion + 1; v <= toVersion; ++v) {
            if (!migrateToVersion(db, v)) {
                return false;
            }
        }
        return true;
    }

private:
    static bool migrateToVersion(QSqlDatabase& db, int version) {
        switch (version) {
        case 2:
            return migrateV1ToV2(db);
        case 3:
            return migrateV2ToV3(db);
        // ... 更多版本
        default:
            return false;
        }
    }

    static bool migrateV1ToV2(QSqlDatabase& db) {
        // 示例：添加新字段
        QSqlQuery query(db);
        return query.exec("ALTER TABLE backup_tasks ADD COLUMN priority INTEGER DEFAULT 0");
    }
};
```

### 6.2 数据备份

在执行迁移前，自动备份数据库：

```cpp
bool DatabaseManager::backup(const QString& backupPath) {
    QFile dbFile(m_dbPath);
    return dbFile.copy(backupPath);
}
```

---

## 7. 性能优化

### 7.1 索引策略

已创建的索引：
- `repositories`: type, is_default
- `backup_tasks`: repository_id, enabled, schedule_type
- `backup_history`: task_id, start_time, success
- `snapshots_cache`: repository_id, snapshot_time

### 7.2 查询优化

**常用查询示例：**

```sql
-- 获取仓库的最近10次备份记录
SELECT h.*, t.name as task_name
FROM backup_history h
JOIN backup_tasks t ON h.task_id = t.id
WHERE t.repository_id = ?
ORDER BY h.start_time DESC
LIMIT 10;

-- 获取所有启用的定时任务
SELECT t.*, r.name as repo_name
FROM backup_tasks t
JOIN repositories r ON t.repository_id = r.id
WHERE t.enabled = 1 AND t.schedule_type > 0;

-- 统计备份成功率
SELECT
    task_id,
    COUNT(*) as total,
    SUM(success) as successful,
    CAST(SUM(success) AS REAL) / COUNT(*) * 100 as success_rate
FROM backup_history
GROUP BY task_id;
```

### 7.3 定期维护

```sql
-- 清理旧的备份历史（保留最近90天）
DELETE FROM backup_history
WHERE start_time < datetime('now', '-90 days');

-- 清理过期的快照缓存（超过1小时）
DELETE FROM snapshots_cache
WHERE cached_at < datetime('now', '-1 hour');

-- 压缩数据库
VACUUM;
```

---

## 8. 安全性考虑

### 8.1 密码加密

`password_store`表中的密码使用AES-256加密：

```cpp
QString CryptoUtil::encrypt(const QString& plaintext, const QString& key) {
    // 生成随机IV和salt
    QByteArray iv = generateRandomBytes(16);
    QByteArray salt = generateRandomBytes(16);

    // 从key派生加密密钥
    QByteArray derivedKey = deriveKey(key, salt);

    // AES-256-CBC加密
    QByteArray encrypted = aesEncrypt(plaintext.toUtf8(), derivedKey, iv);

    // 返回: base64(salt + iv + encrypted)
    QByteArray combined = salt + iv + encrypted;
    return QString::fromLatin1(combined.toBase64());
}
```

### 8.2 数据库权限

- 数据库文件权限设置为仅当前用户可读写（Unix: 0600）
- 禁止通过网络访问

### 8.3 SQL注入防护

始终使用参数化查询：

```cpp
QSqlQuery query(m_db);
query.prepare("SELECT * FROM repositories WHERE id = ?");
query.addBindValue(repoId);
query.exec();
```

---

## 9. 示例数据

### 9.1 repositories表示例

| id | name | type | path | config | created_at | last_backup | is_default |
|----|------|------|------|--------|------------|-------------|------------|
| 1 | 本地备份仓库 | local | /srv/restic-repo | {} | 2025-10-20T10:00:00 | 2025-10-20T14:00:00 | 1 |
| 2 | 远程SFTP仓库 | sftp | user@192.168.1.100:/backup | {"host":"192.168.1.100","port":22,"user":"backup"} | 2025-10-20T11:00:00 | NULL | 0 |

### 9.2 backup_tasks表示例

| id | name | repository_id | source_paths | exclude_patterns | schedule_type | enabled |
|----|------|---------------|--------------|------------------|---------------|---------|
| 1 | 工作文档备份 | 1 | ["/home/user/work"] | ["*.tmp","node_modules/"] | 2 | 1 |
| 2 | 家庭照片备份 | 2 | ["/home/user/Pictures"] | [] | 3 | 1 |

### 9.3 backup_history表示例

| id | task_id | snapshot_id | start_time | end_time | success | files_new | data_added |
|----|---------|-------------|------------|----------|---------|-----------|------------|
| 1 | 1 | a3f5c8d2 | 2025-10-20T14:00:00 | 2025-10-20T14:15:30 | 1 | 125 | 1024000000 |
| 2 | 1 | b8k2m9x1 | 2025-10-21T14:00:00 | 2025-10-21T14:10:20 | 1 | 8 | 52428800 |

---

**文档结束**
